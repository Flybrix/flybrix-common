!function(){"use strict";angular.module("flybrixCommon",[])}(),function(){"use strict";function e(){this.index=0}function n(){return 0}function t(e){var n=l["Uint"+e];if(void 0===n)throw new Error("Unsupported split bit count: "+e+". Allowed counts: 8, 16, 32, 64");return n}function r(e){function n(n,t,r){c.encode(n,t,a(r,e))}function t(n,t){return o(c.decode(n,t),e)}function r(){return""}function u(){return e}var c=i(e,l.Uint8);return new f(u,n,t,r)}function a(e,n){var t=new Uint8Array(n);return e.split("").forEach(function(e,n){t[n]=e.charCodeAt(0)}),t[n-1]=0,t}function o(e,n){for(var t="",r=Math.min(e.length,n-1),a=0;a<r;++a){if(0===e[a])return t;t+=String.fromCharCode(e[a])}return t}function i(e,n,r){function a(t,r,a){for(var o=0;o<e;++o)n.encode(t,r,a[o])}function o(t,r){for(var a=[],o=0;o<e;++o)a.push(n.decode(t,r));return a}function i(){for(var t=[],r=0;r<e;++r)t.push(n.empty());return t}function u(t,r,a,o){var i=o.pop();m.encode(t,r,i);for(var u=0;u<e;++u)i&1<<u&&n.encodePartial(t,r,a[u],o)}function c(t,r,a){for(var o=m.decode(t,r),i=[],u=0;u<e;++u)o&1<<u?i.push(n.decodePartial(t,r,a[u])):i.push(a[u]);return i}function l(t){var a,o=!0;void 0!==t&&(a=t.pop(),o=!1);for(var i=o?0:r/8,u=0;u<e;++u)(o||a&1<<u)&&(i+=n.bytecount(t));return i}function s(t,r,a,o){for(var i=0;i<e;++i)n.encodePartial(t,r,a[i],o)}function d(t,r,a){for(var o=[],i=0;i<e;++i)o.push(n.decodePartial(t,r,a[i]));return o}function _(t){for(var r=0,a=0;a<e;++a)r+=n.bytecount(t);return r}if(void 0===e)throw new Error("Array type requires length");if(!(n instanceof f))throw new Error("Array type requires Handler type as element");var T;if(void 0!==r){var m=t(r);T=new f(l,a,o,i,u,c)}else T=new f(_,a,o,i,s,d);return T.children={element:n,count:e},T}function u(e,n){function r(n,t,r){e.forEach(function(e,a){e.encode(n,t,r[a])})}function a(n,t){var r=[];return e.forEach(function(e,a){r.push(e.decode(n,t))}),r}function o(){var n=[];return e.forEach(function(e){n.push(e.empty())}),n}function i(n,t,r,a){var o=a.pop();m.encode(n,t,o),e.forEach(function(e,i){o&1<<i&&e.encodePartial(n,t,r[i],a)})}function u(n,t,r){var a=m.decode(n,t),o=[];return e.forEach(function(e,i){a&1<<i?o.push(e.decodePartial(n,t,r[i])):o.push(r[i])}),o}function c(t){var r,a=!0;return void 0!==t&&(r=t.pop(),a=!1),e.reduce(function(e,n,o){return a||r&1<<o?e+n.bytecount(t):e},a?0:n/8)}function l(n,t,r,a){e.forEach(function(e,o){e.encodePartial(n,t,r[o],a)})}function s(n,t,r){var a=[];return e.forEach(function(e,o){a.push(e.decodePartial(n,t,r[o]))}),a}function d(n){return e.reduce(function(e,t){return e+t.bytecount(n)},0)}var _=e.length;if(void 0===_)throw new Error("Polyarray type requires an array of Handler objects");e.forEach(function(e){if(!(e instanceof f))throw new Error("Polyarray type requires an array of Handler objects")});var T;e.reduce(function(e,n){return e+n.bytecount},0);if(void 0!==n){var m=t(n);T=new f(c,r,a,o,i,u)}else T=new f(d,r,a,o,l,s);return T.children=e,T}function c(e,n){function r(n,t,r){e.forEach(function(e){e.element.encode(n,t,r[e.key])})}function a(n,t){var r={};return e.forEach(function(e){r[e.key]=e.element.decode(n,t)}),r}function o(){var n={};return e.forEach(function(e){n[e.key]=e.element.empty()}),n}function i(n,t,r,a){var o=a.pop();m.encode(n,t,o),e.forEach(function(e){o&1<<e.part&&e.element.encodePartial(n,t,r[e.key],a)})}function u(n,t,r){var a=m.decode(n,t),o={};return e.forEach(function(e){a&1<<e.part?o[e.key]=e.element.decodePartial(n,t,r[e.key]):o[e.key]=r[e.key]}),o}function c(t){var r,a=!0;return void 0!==t&&(r=t.pop(),a=!1),e.reduce(function(e,n){return a||r&1<<n.part?e+n.element.bytecount(t):e},a?0:n/8)}function l(n,t,r,a){e.forEach(function(e){e.element.encodePartial(n,t,r[e.key],a)})}function s(n,t,r){var a={};return e.forEach(function(e){a[e.key]=e.element.decodePartial(n,t,r[e.key])}),a}function d(n){return e.reduce(function(e,t){return e+t.element.bytecount(n)},0)}var _=e.length;if(void 0===_)throw new Error("Map type requires an array of {key: String, element: Handler} maps");e.forEach(function(e){if(void 0===e.key||!(e.element instanceof f))throw new Error("Map type requires an array of {key: String, element: Handler} maps")}),void 0!==n&&e.forEach(function(e){if(void 0===e.part)throw new Error("Map type requires an array of {key: String, element: Handler, part: Number} maps when split bits are defined")});var T;if(void 0!==n){var m=t(n);T=new f(c,r,a,o,i,u)}else T=new f(d,r,a,o,l,s);return T.children=e,T}function f(e,n,t,r,a,o){a=a||n,o=o||t,this.bytecount=e,this.encode=n,this.decode=t,this.encodePartial=a,this.decodePartial=o,this.empty=r}angular.module("flybrixCommon").factory("encodable",function(){return l});var l={string:r,map:c,array:i,polyarray:u,Serializer:e};e.prototype.add=function(e){this.index+=e},["Uint","Int"].forEach(function(e){[1,2,4].forEach(function(t){function r(e,n,r){e["set"+i](n.index,r,1),n.add(t)}function a(e,n){var r=e["get"+i](n.index,1);return n.add(t),r}function o(){return t}var i=e+8*t;l[i]=new f(o,r,a,n)})}),[4,8].forEach(function(e){function t(n,t,r){n["set"+o](t.index,r,1),t.add(e)}function r(n,t){var r=n["get"+o](t.index,1);return t.add(e),r}function a(){return e}var o="Float"+8*e;l[o]=new f(a,t,r,n)}),l.bool=new f(function(){return 1},function(e,n,t){l.Uint8.encode(e,n,t?1:0)},function(e,n){return 0!==l.Uint8.decode(e,n)},function(){return!1})}(),function(){"use strict";function e(e){var n={},t=e,r=t.map([{key:"red",element:t.Uint8},{key:"green",element:t.Uint8},{key:"blue",element:t.Uint8}]),a=t.map([{key:"status",element:t.Uint16},{key:"pattern",element:t.Uint8},{key:"colors",element:t.map([{key:"right_front",element:r},{key:"right_back",element:r},{key:"left_front",element:r},{key:"left_back",element:r}])},{key:"indicator_red",element:t.bool},{key:"indicator_green",element:t.bool}]),o=t.array(3,t.Float32),i=(t.array(3,t.Uint8),t.array(6,t.Uint8)),u=t.array(6,t.Uint16),c=t.array(7,t.Float32),f=t.array(2,t.Float32),l=t.array(16,a,16),s=(t.string(9),[{part:0,key:"version",element:t.array(3,t.Uint8)},{part:1,key:"id",element:t.Uint32},{part:2,key:"pcbOrientation",element:o},{part:2,key:"pcbTranslation",element:o},{part:3,key:"mixTableFz",element:t.array(8,t.Int8)},{part:3,key:"mixTableTx",element:t.array(8,t.Int8)},{part:3,key:"mixTableTy",element:t.array(8,t.Int8)},{part:3,key:"mixTableTz",element:t.array(8,t.Int8)},{part:4,key:"magBias",element:o},{part:5,key:"assignedChannel",element:i},{part:5,key:"commandInversion",element:t.Uint8},{part:5,key:"channelMidpoint",element:u},{part:5,key:"channelDeadzone",element:u},{part:6,key:"thrustMasterPIDParameters",element:c},{part:6,key:"pitchMasterPIDParameters",element:c},{part:6,key:"rollMasterPIDParameters",element:c},{part:6,key:"yawMasterPIDParameters",element:c},{part:6,key:"thrustSlavePIDParameters",element:c},{part:6,key:"pitchSlavePIDParameters",element:c},{part:6,key:"rollSlavePIDParameters",element:c},{part:6,key:"yawSlavePIDParameters",element:c},{part:6,key:"pidBypass",element:t.Uint8},{part:7,key:"stateEstimationParameters",element:f},{part:7,key:"enableParameters",element:f},{part:8,key:"ledStates",element:l},{part:9,key:"name",element:t.string(9)}]);n["1.4.0"]=t.map(s.slice(),16);var d=[{part:6,key:"thrustGain",element:t.Float32},{part:6,key:"pitchGain",element:t.Float32},{part:6,key:"rollGain",element:t.Float32},{part:6,key:"yawGain",element:t.Float32}];return s=s.slice(0,21).concat(d,s.slice(21)),n["1.5.0"]=t.map(s.slice(),16),n}angular.module("flybrixCommon").factory("configHandler",e),e.$inject=["encodable"]}(),function(){"use strict";function e(e){var n=[0,0,0],t="0.0.0",r={"1.4.0":!0,"1.5.0":!0},a=[1,5,0],o="1.5.0",i=e[o],u=i,c={"1.4.0":134217727,"1.5.0":134217727},f=4294967295;return{set:function(r){n=r,t=r.join("."),u=e[t]||i,f=c[t]||4294967295},get:function(){return n},key:function(){return t},supported:function(){return r[t]===!0},desired:function(){return a},desiredKey:function(){return o},configHandler:function(){return u},stateMask:function(){return f}}}angular.module("flybrixCommon").factory("firmwareVersion",e),e.$inject=["configHandler"]}(),function(){"use strict";function e(e,n){function t(){return e("Calibrating magnetometer bias"),n.send(n.field.COM_SET_CALIBRATION,[1,0],!1)}function r(t,r){return e("Calibrating gravity for pose: "+t),n.send(n.field.COM_SET_CALIBRATION,[1,r+1],!1)}function a(){return e("Finishing calibration"),n.send(n.field.COM_SET_CALIBRATION,[0,0],!1)}return{magnetometer:t,accelerometer:{flat:r.bind(null,"flat",0),forward:r.bind(null,"lean forward",1),back:r.bind(null,"lean back",2),right:r.bind(null,"lean right",3),left:r.bind(null,"lean left",4)},finish:a}}angular.module("flybrixCommon").factory("calibration",e),e.$inject=["commandLog","serial"]}(),function(){"use strict";function e(){return{Reader:n,encode:r}}function n(e){void 0===e&&(e=2e3),this.N=e,this.buffer=new Uint8Array(e),this.ready_for_new_message=!0,this.buffer_length=0}function t(e){for(var n=0,t=0,r=0,a=!1;e.buffer[n];)r?(--r,e.buffer[t++]=e.buffer[n++]):(a&&(e.buffer[t++]=0),r=e.buffer[n++]-1,a=r<254);return r?0:t}function r(e){for(var n=new Uint8Array(Math.floor((255*e.byteLength+761)/254)),t=1,r=0,a=0;a<e.length;++a){254==n[r]&&(n[r]=255,r=t++,n[r]=0);var o=e[a];++n[r],o?n[t++]=o:(r=t++,n[r]=0)}return n.subarray(0,t).slice().buffer}angular.module("flybrixCommon").factory("cobs",e),n.prototype.AppendToBuffer=function(e,n,r){for(var a=0;a<e.length;a++){var o=e[a];if(this.ready_for_new_message&&(this.ready_for_new_message=!1,this.buffer_length=0),this.buffer[this.buffer_length++]=o,o&&this.buffer_length==this.N)r("overflow","buffer overflow in COBS decoding"),this.ready_for_new_message=!0;else if(!o){this.buffer_length=t(this);var i=0===this.buffer_length;i&&(this.buffer[0]=1);for(var u=1;u<this.buffer_length;++u)this.buffer[0]^=this.buffer[u];if(0===this.buffer[0])if(this.ready_for_new_message=!0,this.buffer_length>5){for(var c=this.buffer[1],f=0,l=0;l<4;++l)f|=this.buffer[l+2]<<8*l;n(c,f,this.buffer.subarray(6,this.buffer_length).slice().buffer)}else r("short","Too short packet");else{this.ready_for_new_message=!0;for(var s="",d="",u=0;u<this.buffer_length;u++)s+=this.buffer[u]+",",d+=String.fromCharCode(this.buffer[u]);if(i)r("frame","Unexpected ending of packet");else{var _="BAD CHECKSUM ("+this.buffer_length+" bytes)"+s+d;r("checksum",_)}}}}}}(),function(){"use strict";function e(e){function n(e){void 0!==e&&(o.push(e),i.notify(t()))}function t(){return o}function r(){i=e.defer()}function a(e){return i.promise.then(void 0,void 0,e)}var o=[],i=e.defer(),u=n;return u.log=n,u.clearSubscribers=r,u.onMessage=a,u.read=t,u}angular.module("flybrixCommon").factory("commandLog",e),e.$inject=["$q"]}(),function(){"use strict";function e(e,n,t){function r(e,n,t,r,o,u){a(e,n,t,function(){i(n,t,r)},o,u)}function a(n,t,r,a,i,c){switch(n){case u.State:a(t,r);break;case u.Command:i(t,r);break;case u.DebugString:var f=o(r);e('Received <span style="color: orange">DEBUG</span>: '+f);break;case u.HistoryData:var f=o(r);e('Received <span style="color: orange">HISTORY DATA</span>');break;case u.Response:var l=new DataView(r,0);c(t,l.getInt32(0,1))}}function o(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function i(e,r,a){var o=d.empty(),i=[],u=new DataView(r,0),c=new n.Serializer,l=0;e&=t.stateMask(),d.children.forEach(function(n,t){var r=1<<t;if(e&r){i[t]=!0;var a=n.element,f=n.key;o[f]=a.decode(u,c)}}),e&f.STATE_MICROS&&(l=1e6/(o.timestamp_us-s),s=o.timestamp_us),e&f.STATE_TEMPERATURE&&(o.temperature/=100),e&f.STATE_PRESSURE&&(o.pressure/=256),a(o,i,l)}var u={State:0,Command:1,DebugString:3,HistoryData:4,Response:255},c={COM_REQ_RESPONSE:1,COM_SET_EEPROM_DATA:2,COM_REINIT_EEPROM_DATA:4,COM_REQ_EEPROM_DATA:8,COM_REQ_ENABLE_ITERATION:16,COM_MOTOR_OVERRIDE_SPEED_0:32,COM_MOTOR_OVERRIDE_SPEED_1:64,COM_MOTOR_OVERRIDE_SPEED_2:128,COM_MOTOR_OVERRIDE_SPEED_3:256,COM_MOTOR_OVERRIDE_SPEED_4:512,COM_MOTOR_OVERRIDE_SPEED_5:1024,COM_MOTOR_OVERRIDE_SPEED_6:2048,COM_MOTOR_OVERRIDE_SPEED_7:4096,COM_MOTOR_OVERRIDE_SPEED_ALL:8160,COM_SET_COMMAND_OVERRIDE:8192,COM_SET_STATE_MASK:16384,COM_SET_STATE_DELAY:32768,COM_SET_SD_WRITE_DELAY:65536,COM_SET_LED:1<<17,COM_SET_SERIAL_RC:1<<18,COM_SET_CARD_RECORDING:1<<19,COM_SET_PARTIAL_EEPROM_DATA:1<<20,COM_REINIT_PARTIAL_EEPROM_DATA:1<<21,COM_REQ_PARTIAL_EEPROM_DATA:1<<22,COM_REQ_CARD_RECORDING_STATE:1<<23,COM_SET_PARTIAL_TEMPORARY_CONFIG:1<<24,COM_SET_COMMAND_SOURCES:1<<25,COM_SET_CALIBRATION:1<<26},f={STATE_ALL:4294967295,STATE_NONE:0,STATE_MICROS:1,STATE_STATUS:2,STATE_V0:4,STATE_I0:8,STATE_I1:16,STATE_ACCEL:32,STATE_GYRO:64,STATE_MAG:128,STATE_TEMPERATURE:256,STATE_PRESSURE:512,STATE_RX_PPM:1024,STATE_AUX_CHAN_MASK:2048,STATE_COMMANDS:4096,STATE_F_AND_T:8192,STATE_PID_FZ_MASTER:16384,STATE_PID_TX_MASTER:32768,STATE_PID_TY_MASTER:65536,STATE_PID_TZ_MASTER:1<<17,STATE_PID_FZ_SLAVE:1<<18,STATE_PID_TX_SLAVE:1<<19,STATE_PID_TY_SLAVE:1<<20,STATE_PID_TZ_SLAVE:1<<21,STATE_MOTOR_OUT:1<<22,STATE_KINE_ANGLE:1<<23,STATE_KINE_RATE:1<<24,STATE_KINE_ALTITUDE:1<<25,STATE_LOOP_COUNT:1<<26},l={STATUS_BOOT:1,STATUS_MPU_FAIL:2,STATUS_BMP_FAIL:4,STATUS_RX_FAIL:8,STATUS_IDLE:16,STATUS_ENABLING:32,STATUS_CLEAR_MPU_BIAS:64,STATUS_SET_MPU_BIAS:128,STATUS_FAIL_STABILITY:256,STATUS_FAIL_ANGLE:512,STATUS_FAIL_OTHER:16384,STATUS_ENABLED:1024,STATUS_BATTERY_LOW:2048,STATUS_TEMP_WARNING:4096,STATUS_LOG_FULL:8192,STATUS_OVERRIDE:32768},s=0,d=function(){var e=n,t=e.polyarray([e.Uint32,e.Float32,e.Float32,e.Float32,e.Float32,e.Float32]);return e.map([{key:"timestamp_us",element:e.Uint32},{key:"status",element:e.Uint16},{key:"V0_raw",element:e.Uint16},{key:"I0_raw",element:e.Uint16},{key:"I1_raw",element:e.Uint16},{key:"accel",element:e.array(3,e.Float32)},{key:"gyro",element:e.array(3,e.Float32)},{key:"mag",element:e.array(3,e.Float32)},{key:"temperature",element:e.Uint16},{key:"pressure",element:e.Uint32},{key:"ppm",element:e.array(6,e.Int16)},{key:"AUX_chan_mask",element:e.Uint8},{key:"command",element:e.array(4,e.Int16)},{key:"control",element:e.array(4,e.Float32)},{key:"pid_master_Fz",element:t},{key:"pid_master_Tx",element:t},{key:"pid_master_Ty",element:t},{key:"pid_master_Tz",element:t},{key:"pid_slave_Fz",element:t},{key:"pid_slave_Tx",element:t},{key:"pid_slave_Ty",element:t},{key:"pid_slave_Tz",element:t},{key:"MotorOut",element:e.array(8,e.Int16)},{key:"kinematicsAngle",element:e.array(3,e.Float32)},{key:"kinematicsRate",element:e.array(3,e.Float32)},{key:"kinematicsAltitude",element:e.Float32},{key:"loopCount",element:e.Uint32}])}();return{processBinaryDatastream:r,MessageType:u,CommandFields:c,StatusCodes:l,StateFields:f}}angular.module("flybrixCommon").factory("parser",e),e.$inject=["commandLog","encodable","firmwareVersion"]}(),function(){"use strict";function e(e,n){function t(e){return{red:e>>16&255,green:e>>8&255,blue:255&e}}function r(e,n,r,a,o,i){return void 0===a&&(a=r),r=t(r),a=t(a),o=o||!1,i=i||!1,{status:e,pattern:n,colors:{right_front:r,right_back:r,left_front:a,left_back:a},indicator_red:o,indicator_green:i}}function a(e){var n=e>>16&255,t=e>>8&255,r=255&e;return n*=.9,t*=.9,r*=.9,Math.floor(n)<<16|Math.floor(t)<<8|Math.floor(r)}function o(n){n=Math.floor(n),n>=0&&n<3||(n=0);var t=e.configHandler(),r={};switch(angular.copy(f),t.children.forEach(function(e){var n=e.key;r[n]=angular.copy(f[n])}),r.id=n,r.version=e.get().slice(),n){case 0:r.mixTableFz=[1,1,0,0,0,0,1,1],r.mixTableTx=[1,1,0,0,0,0,-1,-1],r.mixTableTy=[-1,1,0,0,0,0,-1,1],r.mixTableTz=[1,-1,0,0,0,0,-1,1];break;case 1:r.mixTableFz=[1,1,1,1,0,0,1,1],r.mixTableTx=[1,1,0,0,0,0,-1,-1],r.mixTableTy=[-1,1,-1,1,0,0,-1,1],r.mixTableTz=[1,-1,-1,1,0,0,1,-1];break;case 2:r.mixTableFz=[1,1,1,1,1,1,1,1],r.mixTableTx=[1,1,1,1,-1,-1,-1,-1],r.mixTableTy=[-1,1,-1,1,-1,1,-1,1],r.mixTableTz=[1,-1,-1,1,1,-1,-1,1]}return r}var i={NO_OVERRIDE:0,FLASH:1,BEACON:2,BREATHE:3,ALTERNATE:4,SOLID:5},u={Black:0,Red:16711680,Green:32768,Orange:16753920,Blue:255},c=[r(n.StatusCodes.STATUS_MPU_FAIL,i.SOLID,a(u.Black),a(u.Red),!0),r(n.StatusCodes.STATUS_BMP_FAIL,i.SOLID,a(u.Red),a(u.Black),!0),r(n.StatusCodes.STATUS_BOOT,i.SOLID,a(u.Green)),r(n.StatusCodes.STATUS_RX_FAIL,i.FLASH,a(u.Orange)),r(n.StatusCodes.STATUS_FAIL_OTHER,i.ALTERNATE,a(u.Blue)),r(n.StatusCodes.STATUS_FAIL_STABILITY,i.FLASH,a(u.Black),a(u.Blue)),r(n.StatusCodes.STATUS_FAIL_ANGLE,i.FLASH,a(u.Blue),a(u.Black)),r(n.StatusCodes.STATUS_OVERRIDE,i.BEACON,a(u.Red)),r(n.StatusCodes.STATUS_TEMP_WARNING,i.FLASH,a(u.Red)),r(n.StatusCodes.STATUS_BATTERY_LOW,i.BEACON,a(u.Orange)),r(n.StatusCodes.STATUS_ENABLING,i.FLASH,a(u.Blue)),r(n.StatusCodes.STATUS_ENABLED,i.BEACON,a(u.Blue)),r(n.StatusCodes.STATUS_IDLE,i.BEACON,a(u.Green)),r(0,0,0),r(0,0,0),r(0,0,0)],f={pcbOrientation:[0,0,0],pcbTranslation:[0,0,0],magBias:[0,0,0],assignedChannel:[2,1,0,3,4,5],commandInversion:6,channelMidpoint:[1515,1515,1500,1520,1500,1500],channelDeadzone:[20,20,20,40,20,20],thrustMasterPIDParameters:[1,0,0,0,.005,.005,1],pitchMasterPIDParameters:[10,1,0,10,.005,.005,10],rollMasterPIDParameters:[10,1,0,10,.005,.005,10],yawMasterPIDParameters:[5,1,0,10,.005,.005,180],thrustSlavePIDParameters:[1,0,0,10,.001,.001,.3],pitchSlavePIDParameters:[10,4,0,30,.001,.001,30],rollSlavePIDParameters:[10,4,0,30,.001,.001,30],yawSlavePIDParameters:[30,5,0,20,.001,.001,240],thrustGain:4095,pitchGain:2047,rollGain:2047,yawGain:2047,pidBypass:25,stateEstimationParameters:[1,.01],enableParameters:[.001,30],ledStates:c,name:"FLYBRIX"};return{get:o}}angular.module("flybrixCommon").factory("presets",e),e.$inject=["firmwareVersion","parser"]}(),function(){"use strict";function e(e,n,t,r,a){function o(){}function i(e){p=e,p.onRead=d}function u(){return c()}function c(){return f(a.CommandFields.COM_REQ_PARTIAL_EEPROM_DATA,[1,0,0,0])}function f(o,i,u){void 0===u&&(u=!0);var c=n.defer();o|=a.CommandFields.COM_REQ_RESPONSE;var f,l,s=0;if("object"==typeof i){var d=7+i.length;l=new Uint8Array(d),s^=l[1]=a.MessageType.Command;for(var _=0;_<4;++_)s^=l[_+2]=A(o,_);for(var _=0;_<i.length;_++)s^=l[_+6]=i[_]}else{f=new ArrayBuffer(8),l=new Uint8Array(f),s^=l[1]=a.MessageType.Command;for(var _=0;_<4;++_)s^=l[_+2]=A(o,_);s^=l[6]=i}return l[0]=s,l[l.length-1]=0,S.push({mask:o,response:c}),e(function(){p.send(new Uint8Array(t.encode(l)))},0),u&&r('Sending command <span style="color:blue">'+a.MessageType.Command+"</blue>"),c.promise}function l(){return p.busy()}function s(e){v=e}function d(e){v?v(e,y):R.AppendToBuffer(e,y,_)}function _(e,n){r("COBS decoding failed ("+e+"): "+n)}function T(e){h=e}function m(e){g=e}function E(e,n){for(;S.length>0;){var t=S.shift();{if(t.mask===e){var r=e;if(r&=~a.CommandFields.COM_REQ_RESPONSE,r!==n){t.response.reject("Request was not fully processed");break}t.response.resolve();break}t.response.reject("Missing ACK")}}}function y(e,n,t){a.processBinaryDatastream(e,n,t,h,g,E)}function A(e,n){return e>>8*n&255}var S=[],p=new o,h=function(){r("No state listener defined for serial")},g=function(){r("No command listener defined for serial")},R=new t.Reader(2e3),v=void 0;return o.prototype.busy=function(){return!1},o.prototype.send=function(e){r('No "send" defined for serial backend')},o.prototype.onRead=function(e){r('No "onRead" defined for serial backend')},{busy:l,field:a.CommandFields,send:f,setBackend:i,setStateCallback:T,setCommandCallback:m,setDataHandler:s,handlePostConnect:u,Backend:o}}angular.module("flybrixCommon").factory("serial",e),e.$inject=["$timeout","$q","cobs","commandLog","parser"]}(),function(){"use strict";function e(e,n,t,r){function a(){return r.desired()}function o(){n("Requesting current configuration data..."),e.send(e.field.COM_REQ_EEPROM_DATA,[],!1)}function i(){n("Setting factory default configuration data..."),e.send(e.field.COM_REINIT_EEPROM_DATA,[],!1).then(function(){o()},function(e){n("Request for factory reset failed: "+e)})}function u(t){void 0===t&&(t=y),n("Sending new configuration data...");var r=f(t);return e.send(e.field.COM_SET_EEPROM_DATA,r,!1).then(function(){o()})}function c(n,t,r,a,i){void 0===n&&(n=0),void 0===t&&(t=0),void 0===r&&(r=y);var u=a?e.field.COM_SET_PARTIAL_TEMPORARY_CONFIG:e.field.COM_SET_PARTIAL_EEPROM_DATA,c=l(r,n,t);return e.send(u,c,!1).then(function(){i&&o()})}function f(e){var n=r.configHandler(),a=new Uint8Array(n.bytecount()),o=new DataView(a.buffer,0);return n.encode(o,new t.Serializer,e),a}function l(e,n,a){var o=r.configHandler(),i=new Uint8Array(o.bytecount([a,n])),u=new DataView(i.buffer,0),c=new t.Serializer;return o.encodePartial(u,c,e,[a,n]),i}function s(e){n("Received config!"),y=r.configHandler().decode(new DataView(e,0),new t.Serializer),_()}function d(e){n("Received partial config!"),y=r.configHandler().decodePartial(new DataView(e,0),new t.Serializer,angular.copy(y)),_()}function _(){r.set(y.version),r.supported()?(n('Recieved configuration version: <span style="color: green">'+y.version[0]+"."+y.version[1]+"."+y.version[2]+"</span>"),A()):(n('<span style="color: red">WARNING: Configuration version unsupported!</span>'),n("eeprom version: <strong>"+y.version[0]+"."+y.version[1]+"."+y.version[2]+"</strong> - newest firmware version: <strong>"+r.desiredKey()+"</strong>"))}function T(e){A=e}function m(e){S=e}function E(){return y}var y,A=function(){n("No callback defined for receiving configurations!")},S=function(){n("No callback defined for receiving logging state! Callback arguments: (isLogging, isLocked, delay)")},p={VERSION:1,ID:2,PCB:4,MIX_TABLE:8,MAG_BIAS:16,CHANNEL:32,PID_PARAMETERS:64,STATE_PARAMETERS:128,LED_STATES:256,DEVICE_NAME:512};return e.setCommandCallback(function(t,r){if(t&e.field.COM_SET_EEPROM_DATA&&s(r),t&e.field.COM_SET_PARTIAL_EEPROM_DATA&&d(r),t&(e.field.COM_SET_CARD_RECORDING|e.field.COM_SET_SD_WRITE_DELAY)){var a=new Uint8Array(r);if(a.length>=3){var o=a[0]|a[1]<<8,i=a[2];S(0!==(1&i),0!==(2&i),o)}else n("Bad data given for logging info")}}),y=r.configHandler().empty(),{request:o,reinit:i,send:u,sendPartial:c,getConfig:E,setConfigCallback:T,setLoggingCallback:m,getDesiredVersion:a,field:p}}angular.module("flybrixCommon").factory("deviceConfig",e),e.$inject=["serial","commandLog","encodable","firmwareVersion"]}(),function(){"use strict";function e(e){function n(e,n,t,a,c,f,l){c>0&&c<6&&(u.pattern=c),[e,n,t,a].forEach(function(e,n){if(e){var t=i[o[n]];t.red=e.red,t.green=e.green,t.blue=e.blue}}),void 0!==f&&(u.indicator_red=f),void 0!==l&&(u.indicator_green=l),r()}function t(e,t,r){var o={red:e||0,green:t||0,blue:r||0};n(o,o,o,o,a.SOLID)}function r(){e.sendPartial(e.field.LED_STATES,1,c,!0)}var a={NO_OVERRIDE:0,FLASH:1,BEACON:2,BREATHE:3,ALTERNATE:4,SOLID:5},o=["right_front","right_back","left_front","left_back"],i={};o.forEach(function(e){i[e]={red:0,green:0,blue:0}});var u={status:65535,pattern:a.SOLID,colors:i,indicator_red:!1,indicator_green:!1},c={ledStates:[u]};return{set:n,setSimple:t,patterns:a}}angular.module("flybrixCommon").factory("led",e),e.$inject=["deviceConfig"]}(),function(){"use strict";function e(e,n){function t(){if(b||!e.busy()){b=!1;var t={enabled:!0},r={},a=-.8;r.throttle=E(4095*(S-a)/(1-a),0,4095),r.pitch=E(4095*-y(p,.1)/2,-2047,2047),r.roll=E(4095*y(h,.1)/2,-2047,2047),r.yaw=E(4095*-y(g,.1)/2,-2047,2047),t.command=r,t.auxcode=(1<<R)+(1<<v+3);var o=new Uint8Array(10);return C.encode(new DataView(o.buffer),new n.Serializer,t),e.send(e.field.COM_SET_SERIAL_RC,o,!1)}}function r(e){S=e}function a(e){p=e}function o(e){h=e}function i(e){g=e}function u(e){R=e}function c(e){v=e}function f(){return S}function l(){return p}function s(){return h}function d(){return g}function _(){return R}function T(){return v}function m(){b=!0}function E(e,n,t){return Math.max(n,Math.min(e,t))}function y(e,n){return e>n?e-n:e<-n?e+n:0}var A={LOW:0,MID:1,HIGH:2},S=-1,p=0,h=0,g=0,R=A.HIGH,v=A.HIGH,b=!0,O=n.map([{key:"throttle",element:n.Int16},{key:"pitch",element:n.Int16},{key:"roll",element:n.Int16},{key:"yaw",element:n.Int16}]),C=n.map([{key:"enabled",element:n.bool},{key:"command",element:O},{key:"auxcode",element:n.Uint8}]);return{setThrottle:r,setPitch:a,setRoll:o,setYaw:i,setAux1:u,setAux2:c,getThrottle:f,getPitch:l,getRoll:s,getYaw:d,getAux1:_,getAux2:T,AUX:A,send:t,forceNextSend:m}}angular.module("flybrixCommon").factory("rcData",e),e.$inject=["serial","encodable"]}();